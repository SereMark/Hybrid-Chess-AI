from types import SimpleNamespace as _NS

SEED = 0


LOG = _NS(
    LEVEL="INFO",
    CUDA_EMPTY_CACHE_EVERY_ITERS=120,
    CHECKPOINT_SAVE_EVERY_ITERS=16,
    CHECKPOINT_FILE_PATH="checkpoints/checkpoint.pt",
    BEST_MODEL_FILE_PATH="checkpoints/best_model.pt",
    METRICS_LOG_CSV_ENABLE=True,
    METRICS_LOG_CSV_PATH="logs/training_log.csv",
    ARENA_SAVE_PGN_ENABLE=True,
    ARENA_SAVE_PGN_ON_PROMOTION=True,
    ARENA_SAVE_PGN_SAMPLES_PER_ROUND=2,
    ARENA_PGN_DIR="logs",
)


TORCH = _NS(
    AMP_ENABLED=True,
    MATMUL_FLOAT32_PRECISION="high",
    THREADS_INTRA=1,
    THREADS_INTER=1,
    MODEL_CHANNELS_LAST=True,
    EVAL_MODEL_CHANNELS_LAST=True,
)


DATA = _NS(
    U8_SCALE=255.0,
    VALUE_I8_SCALE=127.0,
)


MODEL = _NS(
    BLOCKS=6,
    CHANNELS=128,
    VALUE_CONV_CHANNELS=16,
    VALUE_HIDDEN_DIM=384,
)


EVAL = _NS(
    COALESCE_MS=22,
    WORKER_JOIN_TIMEOUT_S=0.15,
    BATCH_SIZE_MAX=384,
    CACHE_USE_FP16=True,
    CACHE_CAPACITY=3_000,
    ARENA_CACHE_CAPACITY=2_000,
)


SELFPLAY = _NS(
    NUM_WORKERS=6,
    GAME_MAX_PLIES=148,
    TEMP_MOVES=22,
    TEMP_HIGH=1.10,
    TEMP_LOW=0.45,
    DETERMINISTIC_TEMP_EPS=0.010,
    OPENING_RANDOM_PLIES_MAX=0,
    OPENING_BOOK=(
        ("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", 3.0),
        ("rnbqkbnr/pppp1ppp/8/4p3/3P4/2N5/PPP2PPP/R1BQKBNR b KQkq - 1 2", 1.5),
        ("r1bqkbnr/pp1ppppp/2n5/2p5/3P4/2N2N2/PPP1PPPP/R1BQKB1R w KQkq - 2 4", 1.5),
        ("rnbq1rk1/pp2bppp/2p1pn2/3p4/3P4/2P1PN2/PP1NBPPP/R1BQ1RK1 w - - 4 9", 1.0),
        ("r4rk1/pp2bppp/2n1pn2/2bp4/3P4/1BPBPN2/PP3PPP/RN1QR1K1 w - - 6 16", 1.0),
        ("8/pp3pk1/2p2np1/3p4/2PPp3/1P3P2/PBK2P1P/8 w - - 0 31", 0.8),
        ("8/2p3kp/3p2p1/2pPp3/2P1P3/1P3KP1/6P1/8 w - - 0 41", 0.8),
    ),
    COLOR_FLIP_PROB=0.55,
    COLOR_BALANCE_TOLERANCE_PCT=4.0,
    COLOR_BALANCE_WINDOW_ITERS=8,
    ADJUDICATE_ENABLED=True,
    ADJUDICATE_MATERIAL_MARGIN=4.0,
    ADJUDICATE_MIN_PLIES=112,
    ADJUDICATE_MARGIN_START=6.0,
    ADJUDICATE_MARGIN_END=2.0,
    ADJUDICATE_MARGIN_DECAY_ITER=384,
    ADJUDICATE_MIN_PLIES_START=136,
    ADJUDICATE_MIN_PLIES_END=88,
    ADJUDICATE_MIN_PLIES_DECAY_ITER=384,
    ADJUDICATE_VALUE_MARGIN_START=0.36,
    ADJUDICATE_VALUE_MARGIN_END=0.24,
    ADJUDICATE_VALUE_DECAY_ITER=384,
    ADJUDICATE_VALUE_PERSIST_PLIES=6,
    EXHAUSTION_VALUE_SCALE=0.22,
    EXHAUSTION_VALUE_MAX=0.60,
    ENDGAME_SIM_MOVES=84,
    ENDGAME_SIM_FACTOR=1.6,
    ENDGAME_MATERIAL_TRIGGER=8.0,
    CURRICULUM_SAMPLE_PROB=0.50,
    CURRICULUM_FENS=(
        "1nbqkbnr/rp1pp3/2p5/pN4pp/2B1p2P/1P4P1/P1PP1P2/R1BQK1NR w KQk - 0 9",
        "rnbqkb1r/ppp1p1pp/3p1n2/5p2/7P/4PP2/PPPPK1P1/RNBQ1BNR b kq - 1 4",
        "rnbq1b1r/pp1kppp1/2p5/7p/2P3nP/5PP1/PP1PP3/RNBQK1NR b KQ - 0 6",
        "rn1qkb1r/1bppp2p/7n/p4pp1/p5P1/R2P1P2/1PPKP2P/1NBQ1BNR b kq - 1 8",
        "2r2rk1/pp2bpp1/2n1pn1p/3p4/3P4/1BPBPN2/PP3PPP/2RQ1RK1 w - - 4 18",
        "6k1/5ppp/8/8/8/5PPP/6K1/7Q w - - 0 1",
        "7k/6pp/8/8/8/6PP/5P2/7K b - - 0 1",
        "8/5k2/8/8/3R4/6K1/8/8 w - - 0 1",
        "4k3/8/8/8/8/8/2r5/4K3 w - - 0 1",
        "6k1/5ppp/8/8/8/5PPP/6K1/7b b - - 0 1",
        "8/1p6/2b5/3p1kp1/3P4/1BP3P1/6K1/8 w - - 0 1",
        "6k1/5pp1/1p3b1p/8/5B2/2P3PP/5PK1/8 w - - 0 1",
        "8/5p2/5k1p/8/8/5P1P/5P2/6K1 b - - 0 1",
        "8/6p1/4k3/8/6K1/8/5PP1/8 b - - 0 1",
    ),
)

REPLAY = _NS(
    BUFFER_CAPACITY=50_000,
)

SAMPLING = _NS(
    REPLAY_SNAPSHOT_RECENT_WINDOW_FRAC=0.28,
    REPLAY_SNAPSHOT_RECENT_RATIO_DEFAULT=0.70,
    TRAIN_RECENT_SAMPLE_RATIO=0.70,
    TRAIN_RECENT_SAMPLE_RATIO_MIN=0.45,
    TRAIN_RECENT_SAMPLE_RATIO_MAX=0.80,
    TRAIN_RECENT_SAMPLE_BUFFER_DECAY_START=0.40,
    TRAIN_RECENT_SAMPLE_BUFFER_DECAY_END=0.90,
)

AUGMENT = _NS(
    MIRROR_PROB=0.50,
    ROT180_PROB=0.25,
    VFLIP_CS_PROB=0.25,
)


MCTS = _NS(
    TRAIN_SIMULATIONS_BASE=160,
    TRAIN_SIMULATIONS_MIN=56,
    TRAIN_SIM_DECAY_MOVE_INTERVAL=22,
    C_PUCT=1.35,
    C_PUCT_BASE=19652.0,
    C_PUCT_INIT=1.55,
    DIRICHLET_ALPHA=0.40,
    DIRICHLET_WEIGHT=0.30,
    FPU_REDUCTION=0.11,
    VISIT_COUNT_CLAMP=65535,
)


RESIGN = _NS(
    ENABLED=True,
    VALUE_THRESHOLD=-0.22,
    VALUE_THRESHOLD_INIT=-0.18,
    VALUE_THRESHOLD_RAMP_START=32,
    VALUE_THRESHOLD_RAMP_END=160,
    MIN_PLIES_INIT=70,
    MIN_PLIES_FINAL=32,
    MIN_PLIES_RAMP_END=160,
    CONSECUTIVE_PLIES=3,
    CONSECUTIVE_MIN=2,
    PLAYTHROUGH_FRACTION=0.10,
    DISABLE_UNTIL_ITERS=24,
    GUARD_MIN_AVG_LEN=110.0,
    GUARD_WINDOW_ITERS=16,
    GUARD_COOLDOWN_ITERS=32,
    TARGET_LOSS_VALUE_PCTL=0.20,
    TARGET_WINDOW_GAMES=480,
    EVAL_MARGIN=0.22,
    EVAL_PERSIST_PLIES=3,
)


TRAIN = _NS(
    LR_INIT=1.0e-3,
    LR_WARMUP_STEPS=1_080,
    LR_FINAL=3.5e-4,
    LR_SCHED_STEPS_PER_ITER_EST=60,
    LR_SCHED_DRIFT_ADJUST_THRESHOLD=15.0,
    WEIGHT_DECAY=1.5e-4,
    MOMENTUM=0.9,
    GRAD_CLIP_NORM=1.35,
    LOSS_POLICY_WEIGHT=1.0,
    LOSS_VALUE_WEIGHT=0.90,
    LOSS_VALUE_WEIGHT_LATE=1.10,
    LOSS_VALUE_WEIGHT_SWITCH_ITER=120,
    LOSS_POLICY_LABEL_SMOOTH=0.015,
    LOSS_ENTROPY_COEF_INIT=2.0e-4,
    LOSS_ENTROPY_ANNEAL_ITERS=256,
    LOSS_ENTROPY_COEF_MIN=1.4e-4,
    EMA_ENABLED=True,
    EMA_DECAY=0.9995,
    TOTAL_ITERATIONS=768,
    GAMES_PER_ITER=72,
    TARGET_TRAIN_SAMPLES_PER_NEW=1.0,
    UPDATE_STEPS_MIN=36,
    UPDATE_STEPS_MAX=160,
    BATCH_SIZE_MIN=256,
    BATCH_SIZE_MAX=288,
    BATCH_SIZE=288,
    LR_RESTART_INTERVAL_ITERS=96,
    LR_RESTART_DECAY=0.92,
)


ARENA = _NS(
    MCTS_EVAL_SIMULATIONS=416,
    EVAL_EVERY_ITERS=6,
    GAMES_PER_EVAL=64,
    TEMPERATURE=0.50,
    TEMP_MOVES=16,
    DIRICHLET_WEIGHT=0.08,
    OPENING_RANDOM_PLIES_MAX=0,
    OPENING_TEMPERATURE_EPS=1e-6,
    DRAW_SCORE=0.50,
    GATE_DRAW_WEIGHT=0.45,
    GATE_BASELINE_P=0.500,
    GATE_BASELINE_MARGIN=0.012,
    GATE_Z_EARLY=0.75,
    GATE_Z_LATE=1.05,
    GATE_Z_SWITCH_ITER=220,
    GATE_MIN_GAMES=48,
    GATE_DECISIVE_SECONDARY=True,
    GATE_MIN_DECISIVES=10,
    GATE_FORCE_DECISIVE=True,
    GAME_MAX_PLIES=176,
    RESIGN_ENABLE=False,
    RESIGN_CONSECUTIVE=2,
    RESIGN_VALUE_THRESHOLD=-0.05,
    RESIGN_PLAYTHROUGH_FRACTION=0.05,
    RESIGN_EVAL_MARGIN=0.16,
    RESIGN_EVAL_PERSIST_PLIES=2,
    ADJUDICATE_ENABLED=True,
    ADJUDICATE_MATERIAL_MARGIN=4.0,
    ADJUDICATE_MIN_PLIES=136,
    COUNT_ADJUDICATED_AS_NATURAL=True,
    CANDIDATE_MAX_ROUNDS=4,
    CANDIDATE_MAX_GAMES=200,
    PAIRING_FACTOR=2,
    GATE_EPS=1e-9,
    GATE_MIN_NATURAL_PCT=0.15,
    CURRICULUM_SAMPLE_PROB=0.25,
    CURRICULUM_MIN_WINS=3,
    CURRICULUM_MIN_DECISIVES=3,
    CURRICULUM_FENS=(
        "1nbqkbnr/rp1pp3/2p5/pN4pp/2B1p2P/1P4P1/P1PP1P2/R1BQK1NR w KQk - 0 9",
        "rnbqkb1r/ppp1p1pp/3p1n2/5p2/7P/4PP2/PPPPK1P1/RNBQ1BNR b kq - 1 4",
        "rnbq1b1r/pp1kppp1/2p5/7p/2P3nP/5PP1/PP1PP3/RNBQK1NR b KQ - 0 6",
        "rn1qkb1r/1bppp2p/7n/p4pp1/p5P1/R2P1P2/1PPKP2P/1NBQ1BNR b kq - 1 8",
        "2r2rk1/pp2bpp1/2n1pn1p/3p4/3P4/1BPBPN2/PP3PPP/2RQ1RK1 w - - 4 18",
    ),
)

SAMPLING.NATURAL_DUPLICATE_WEIGHT = 4
SAMPLING.EXHAUST_DUPLICATE_WEIGHT = 1
SAMPLING.ADJUDICATED_DUPLICATE_WEIGHT = 1
